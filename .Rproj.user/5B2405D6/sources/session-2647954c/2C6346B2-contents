# Create package 
unlink(c("src/RcppExports.cpp", "R/RcppExports.R"))

# Recompile attributes
Rcpp::compileAttributes()

# Rebuild documentation
devtools::document()

# Install
devtools::install()
# devtools::install("D:/ahull3D", quiet = FALSE)

# Load your data
library(lidR)
library(dplyr)

# Read LAS file
trees <- readLAS("D:/xxx/lasref/12tree_exampleN.las")
trees_filtered <- filter_poi(trees, treeid %in% c(1,8,9,11,12))

# Extract points
lasdff <- trees_filtered@data[,c("X", "Y", "Z", "treeid")] %>%
  as.data.frame() %>%
  distinct(across(1:3), .keep_all = TRUE) %>%
  as.matrix()


lasdff[,"treeid"] <- ifelse(lasdff[,"treeid"]==8, 2, lasdff[,"treeid"])
lasdff[,"treeid"] <- ifelse(lasdff[,"treeid"]==9, 3, lasdff[,"treeid"])
lasdff[,"treeid"] <- ifelse(lasdff[,"treeid"]==11, 4, lasdff[,"treeid"])
lasdff[,"treeid"] <- ifelse(lasdff[,"treeid"]==12, 5, lasdff[,"treeid"])
# lasdfff <-as.data.frame(lasdff)
# unique(lasdfff$treeid)

##
# Install from GitHub
remotes::install_github("DijoG/DiscreteMorseR")
remotes::install_github("DijoG/ahull3D") 
remotes::install_github("stla/AlphaHull3D")
remotes::install_github("DijoG/TopTreeSegR")

tictoc::tic()
a <- ahull3D::ahull3d(
  points = lasdff[,1:3],
  input_truth = lasdff[,4], 
  alpha = .1
)
tictoc::toc() 
# 24.75 secs

input_truth <- attr(a, "input_truth") # should be a vector or a matrix of 1*x dimensions
face_truth <- attr(a, "face_truth") # should be a matrix of 3*x dimensions
table(input_truth)
str(face_truth)

# Test
tts <- TopTreeSegR::TTS_segmentation(
  lasdf = trees_filtered,
  alpha = .1,           # Alpha-complex parameter
  clip_height = .5,     # Max stem detection height
  max_distance = 1.0,   # Minima connectivity
  cores = 12            # Parallel processing
)

TopTreeSegR::plot_TTS_3d(tts)


lasp <- LAS(data.frame(tts$points))
plot(lasp)

validation <- TopTreeSegR::validate_segmentation(tts)

results <- evaluate_TTS(
  TTS_result = tts,
  input_las = trees_filtered
)


